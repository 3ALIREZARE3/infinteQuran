<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quran Reels</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3358/3358320.png">
</head>
<body>

    <!-- Floating Controls -->
    <div class="controls">
        <button id="modeBtn" onclick="toggleMode()">ðŸ”€ Random</button>
        <div id="status">Loading Quran...</div>
    </div>

    <!-- Infinite Scroll Container -->
    <div class="feed-container" id="feed">
        <!-- Cards will be injected here by JS -->
    </div>

    <script>
        let allVerses = [];
        let viewQueue = []; // The verses currently shown
        let isRandom = true;
        
        // 1. Fetch the Data (Combined Arabic + English)
        async function loadQuran() {
            try {
                // Using risan/quran-json for a single combined file
                const response = await fetch('https://unpkg.com/quran-json@latest/json/quran/en.json');
                const rawData = await response.json();
                
                // normalize data structure into a flat array of verses
                // The source might be flat or nested by surah. Let's handle flat.
                // Based on documentation, this endpoint returns a flat array of objects.
                allVerses = rawData; 
                
                document.getElementById('status').style.display = 'none';
                initFeed();
            } catch (e) {
                document.getElementById('status').innerText = "Error loading. Check internet.";
                console.error(e);
            }
        }

        // 2. Initialize Feed
        function initFeed() {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            
            // Add initial 10 verses to start
            for(let i=0; i<5; i++) {
                appendVerse();
            }
        }

        // 3. Logic to pick next verse
        function getNextVerse() {
            if (isRandom) {
                const randomIndex = Math.floor(Math.random() * allVerses.length);
                return allVerses[randomIndex];
            } else {
                // Sequential logic: find the last rendered index and get next
                // For MVP simplicity, sequential starts from Surah 1, Ayah 1 and goes down
                const lastVerse = viewQueue[viewQueue.length - 1];
                if (!lastVerse) return allVerses[0];
                
                const nextIndex = allVerses.indexOf(lastVerse) + 1;
                return allVerses[nextIndex] || allVerses[0];
            }
        }

        // 4. Create HTML Card
        function appendVerse() {
            const verseData = getNextVerse();
            if(!verseData) return;
            
            viewQueue.push(verseData);

            const card = document.createElement('div');
            card.className = 'verse-card';
            
            card.innerHTML = `
                <div class="content">
                    <div class="arabic">${verseData.text}</div>
                    <div class="english">${verseData.translation}</div>
                    <div class="ref">
                        Surah ${verseData.surah_number} â€¢ Ayah ${verseData.verse_number}
                    </div>
                </div>
            `;
            
            document.getElementById('feed').appendChild(card);
        }

        // 5. Infinite Scroll Observer (Performance)
        // Detect when user hits bottom to load more
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    appendVerse(); // Load next
                    appendVerse(); // Load buffer
                }
            });
        }, { threshold: 0.5 });

        // Observe the last element occasionally? 
        // Simpler approach for MVP: Detect scroll event on container
        const feedContainer = document.getElementById('feed');
        feedContainer.addEventListener('scroll', () => {
            if(feedContainer.scrollTop + feedContainer.clientHeight >= feedContainer.scrollHeight - 600) {
                appendVerse();
            }
        });

        // Toggle Logic
        function toggleMode() {
            isRandom = !isRandom;
            document.getElementById('modeBtn').innerText = isRandom ? "ðŸ”€ Random" : "ðŸ”¢ Ordered";
            initFeed(); // Reset feed on toggle
        }

        // Initialize PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

        // Start
        loadQuran();

    </script>
</body>
</html>